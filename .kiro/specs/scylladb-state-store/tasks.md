# План Реализации

- [x] 1. Настройка инфраструктуры проекта и базовых интерфейсов
  - Создать структуру каталогов для нового модуля ScyllaDB state store
  - Определить базовые интерфейсы и типы данных для интеграции
  - Настроить зависимости Go модулей (gocql, testify, prometheus)
  - _Требования: 1.1, 4.1_

- [x] 2. Реализация конфигурации ScyllaDB
- [x] 2.1 Создать структуру конфигурации и валидацию
  - Реализовать структуру Config с полями подключения, TLS, производительности
  - Добавить методы валидации конфигурации и значения по умолчанию
  - Создать JSON маршалинг/демаршалинг для конфигурации
  - _Требования: 1.1, 1.4, 8.1, 8.4_

- [x] 2.2 Реализовать TLS и аутентификацию
  - Добавить поддержку TLS конфигурации с сертификатами
  - Реализовать аутентификацию по имени пользователя/паролю и на основе сертификатов
  - Создать методы для создания безопасных соединений
  - _Требования: 8.1, 8.2, 8.3_

- [x] 3. Создание схемы базы данных и миграций
- [x] 3.1 Определить схему таблиц ScyllaDB
  - Создать CQL скрипты для keyspace и таблиц pins_by_cid, placements_by_cid, pins_by_peer
  - Реализовать оптимизированное партиционирование по mh_prefix
  - Добавить настройки компакции и TTL для оптимальной производительности
  - _Требования: 2.1, 2.2, 7.3_

- [x] 3.2 Реализовать систему миграций
  - Создать механизм версионирования схемы базы данных
  - Реализовать автоматическое применение миграций при запуске
  - Добавить проверки совместимости версий схемы
  - _Требования: 4.3_

- [x] 4. Основная реализация ScyllaState
- [x] 4.1 Создать базовую структуру ScyllaState
  - Реализовать структуру ScyllaState с gocql.Session и конфигурацией
  - Добавить методы инициализации и подключения к кластеру ScyllaDB
  - Создать подготовленные запросы для основных операций
  - _Требования: 4.1, 4.2, 7.1_

- [x] 4.2 Реализовать методы интерфейса state.ReadOnly
  - Реализовать метод Get() для получения пина по CID
  - Добавить метод Has() для проверки существования пина
  - Создать метод List() с поддержкой потоковой передачи больших результатов
  - _Требования: 2.2, 4.2_

- [x] 4.3 Реализовать методы интерфейса state.WriteOnly
  - Создать метод Add() для добавления/обновления пинов
  - Реализовать метод Rm() для удаления пинов с правильной очисткой
  - Добавить поддержку условных обновлений для предотвращения состояний гонки
  - _Требования: 2.1, 2.3, 2.4_

- [x] 5. Реализация пакетной обработки и производительности
- [x] 5.1 Создать ScyllaBatchingState
  - Реализовать структуру BatchingState с поддержкой gocql.Batch
  - Добавить метод Commit() для применения пакетных операций
  - Создать логику группировки операций в эффективные пакеты
  - _Требования: 4.1, 7.2_

- [x] 5.2 Оптимизировать производительность соединений
  - Настроить пулы соединений с оптимальными параметрами
  - Реализовать token-aware и DC-aware маршрутизацию для мульти-DC
  - Добавить кэширование подготовленных запросов
  - _Требования: 6.1, 6.4, 7.1_

- [x] 6. Обработка ошибок и отказоустойчивость
- [x] 6.1 Реализовать политики повторов
  - Создать RetryPolicy с экспоненциальной задержкой
  - Добавить логику определения повторяемых ошибок
  - Реализовать повторы с учетом контекста и поддержкой отмены
  - _Требования: 3.1, 3.2_

- [x] 6.2 Добавить плавную деградацию
  - Реализовать обработку недоступности узлов ScyllaDB
  - Добавить автоматическое переключение на доступные реплики
  - Создать механизмы восстановления после сетевых разделений
  - _Требования: 3.1, 3.3, 3.4_

- [ ] 7. Мониторинг и наблюдаемость
- [x] 7.1 Реализовать метрики Prometheus
  - Создать метрики для задержки, пропускной способности, частоты ошибок операций
  - Добавить метрики состояния соединений и пула
  - Реализовать метрики специфичные для ScyllaDB (таймауты, ошибки недоступности)
  - _Требования: 5.1, 5.3_

- [x] 7.2 Добавить структурированное журналирование
  - Реализовать контекстное журналирование операций с CID и длительностью
  - Добавить детальное журналирование ошибок с кодами ошибок ScyllaDB
  - Создать трассировку уровня отладки для устранения неполадок
  - _Требования: 5.2, 5.4_

- [x] 8. Сериализация и совместимость
- [x] 8.1 Реализовать сериализацию пинов
  - Использовать существующий api.Pin.ProtoMarshal() для совместимости
  - Добавить методы serializePin/deserializePin
  - Создать обработку версионности сериализованных данных
  - _Требования: 4.2_

- [x] 8.2 Добавить поддержку Marshal/Unmarshal
  - Реализовать метод Marshal() для экспорта состояния
  - Создать метод Unmarshal() для импорта состояния
  - Добавить метод Migrate() для обновления старых форматов
  - _Требования: 4.3_

- [x] 9. Утилиты миграции данных
- [x] 9.1 Создать инструменты миграции
  - Реализовать Migrator для переноса данных с существующих бэкендов
  - Добавить поддержку пакетной миграции для больших объемов данных
  - Создать валидацию целостности данных после миграции
  - _Требования: 4.3_

- [x] 9.2 Добавить утилиты командной строки
  - Создать команды для экспорта/импорта состояния
  - Реализовать утилиты для проверки состояния ScyllaDB
  - Добавить инструменты для мониторинга процесса миграции
  - _Требования: 4.3_

- [-] 10. Комплексное тестирование
- [ ] 10.1 Создать модульные тесты
  - Написать тесты для всех методов ScyllaState с mock ScyllaDB
  - Добавить тесты конфигурации и валидации
  - Создать тесты политик повторов и обработки ошибок
  - _Требования: 4.4_

- [ ] 10.2 Реализовать интеграционные тесты
  - Создать тесты с реальным ScyllaDB в Docker контейнерах
  - Добавить тесты многоузлового кластера и переключения при отказе
  - Реализовать тесты миграции данных между бэкендами
  - _Требования: 4.4, 3.1, 3.3_

- [ ] 10.3 Добавить тесты производительности
  - Создать бенчмарки для операций Add/Get/List/Rm
  - Реализовать нагрузочные тесты с большими объемами данных
  - Добавить тесты производительности пакетных операций
  - _Требования: 7.1, 7.2_

- [ ] 11. Документация и примеры
- [ ] 11.1 Создать документацию по конфигурации
  - Написать руководство по настройке ScyllaDB state store
  - Добавить примеры конфигураций для различных сценариев
  - Создать документацию по развертыванию в нескольких дата-центрах
  - _Требования: 1.1, 6.1, 6.2_

- [ ] 11.2 Добавить примеры использования
  - Создать примеры кода для инициализации и использования
  - Реализовать примеры миграции с существующих бэкендов
  - Добавить примеры мониторинга и устранения неполадок
  - _Требования: 4.1, 5.1_

- [ ] 12. Реализация Security/AuthZ слоя
- [ ] 12.1 Создать Auth Service компонент
  - Реализовать структуру AuthService с поддержкой JWT, API ключей, DID подписей
  - Добавить интерфейсы Authenticator и Authorizer
  - Создать Audit Logger для записи всех попыток доступа
  - _Требования: 9.1, 9.4_

- [ ] 12.2 Реализовать аутентификацию
  - Добавить поддержку JWT токенов с валидацией подписи и срока действия
  - Реализовать аутентификацию по API ключам с хешированием и ротацией
  - Создать поддержку DID/Web3 подписей для децентрализованной аутентификации
  - _Требования: 9.1, 9.2_

- [ ] 12.3 Реализовать авторизацию
  - Создать Policy Engine для RBAC/ABAC проверок
  - Реализовать проверки прав доступа на уровне операций (pin/unpin/list)
  - Добавить поддержку tenant-based изоляции данных
  - _Требования: 9.3, 9.5_

- [ ] 12.4 Интегрировать с Identity Providers
  - Добавить поддержку OIDC интеграции с Keycloak/Auth0
  - Реализовать интеграцию с Web3 кошельками (MetaMask, WalletConnect)
  - Создать fallback на встроенную систему пользователей
  - _Требования: 9.2_

- [ ] 13. Реализация системы биллинга
- [ ] 13.1 Создать Billing Service компонент
  - Реализовать структуру BillingService с компонентами Usage Collector, Cost Calculator, Invoice Emitter
  - Добавить таблицы storage_usage и billing_events в ScyllaDB
  - Создать NATS топик billing.event для асинхронной обработки
  - _Требования: 10.1, 10.2_

- [ ] 13.2 Реализовать сбор метрик использования
  - Создать Usage Collector для агрегации данных использования хранилища
  - Реализовать ежедневные rollup операции по owner_id
  - Добавить отслеживание размеров пинов и времени хранения
  - _Требования: 10.1, 10.2_

- [ ] 13.3 Реализовать расчет стоимости
  - Создать Cost Calculator с настраиваемыми тарифными планами
  - Реализовать различные модели ценообразования (за GB/месяц, за операцию)
  - Добавить поддержку скидок и промо-кодов
  - _Требования: 10.3_

- [ ] 13.4 Интегрировать с платежными системами
  - Реализовать интеграцию со Stripe для традиционных платежей
  - Добавить поддержку Filecoin Payment Channels
  - Создать интеграцию с L2 решениями (Polygon, Arbitrum)
  - _Требования: 10.4_

- [ ] 14. Реализация enterprise мониторинга
- [ ] 14.1 Расширить метрики Prometheus
  - Добавить SLO метрики (pin_end_to_end_seconds, global_drift_ratio)
  - Реализовать метрики для всех компонентов (Auth, Billing, Workers)
  - Создать recording rules для агрегации метрик
  - _Требования: 11.1, 11.2_

- [ ] 14.2 Создать систему алертинга
  - Реализовать алерты для нарушения SLO (задержка > 60s, дрейф > 0.5%)
  - Добавить алерты для критических ошибок компонентов
  - Создать runbook для устранения типовых проблем
  - _Требования: 11.3_

- [ ] 14.3 Создать Grafana дашборды
  - Реализовать дашборд с ключевыми SLO метриками
  - Добавить дашборды для мониторинга компонентов (ScyllaDB, NATS, Workers)
  - Создать дашборд биллинга с метриками использования и доходов
  - _Требования: 11.4_

- [ ] 15. Реализация enterprise архитектуры
- [ ] 15.1 Создать API Gateway компонент
  - Реализовать API Gateway с интеграцией Auth Service
  - Добавить rate limiting и request validation
  - Создать middleware для логирования и метрик
  - _Требования: 12.1, 12.5_

- [ ] 15.2 Реализовать NATS интеграцию
  - Настроить NATS JetStream для надежной доставки сообщений
  - Создать топики pin.request, pin.assign, pin.status, billing.event
  - Реализовать durable consumers с retry логикой
  - _Требования: 12.2_

- [ ] 15.3 Создать Worker Agent компонент
  - Реализовать stateless Pin Worker Agent с NATS интеграцией
  - Добавить Kubo HTTP Client с retry и timeout логикой
  - Создать Status Reporter для отправки результатов операций
  - _Требования: 12.1, 12.3_

- [ ] 15.4 Реализовать Reconciler Engine
  - Создать control loop для сравнения desired vs actual состояния
  - Реализовать планировщик задач для балансировки нагрузки
  - Добавить TTL Scheduler для автоматического удаления просроченных пинов
  - _Требования: 12.4_

- [ ] 16. Enterprise тестирование и развертывание
- [ ] 16.1 Создать интеграционные тесты enterprise компонентов
  - Написать тесты для Auth Service с различными методами аутентификации
  - Создать тесты Billing Service с mock платежными системами
  - Реализовать end-to-end тесты полного пайплайна пиннинга
  - _Требования: 9.1, 10.1, 12.1_

- [ ] 16.2 Создать нагрузочные тесты
  - Реализовать тесты производительности для enterprise нагрузок
  - Добавить тесты масштабирования с множественными воркерами
  - Создать тесты отказоустойчивости с симуляцией сбоев компонентов
  - _Требования: 12.1, 12.4_

- [ ] 16.3 Подготовить Docker и Kubernetes развертывание
  - Создать Dockerfile для всех компонентов
  - Реализовать Kubernetes манифесты с ConfigMaps и Secrets
  - Добавить Helm charts для упрощенного развертывания
  - _Требования: 12.5_

- [ ] 17. Интеграция в IPFS-Cluster
- [ ] 17.1 Добавить поддержку в конфигурацию кластера
  - Модифицировать конфигурацию кластера для поддержки бэкенда ScyllaDB
  - Добавить фабричные методы для создания ScyllaState
  - Интегрировать в существующую систему конфигурации
  - _Требования: 1.1, 1.2_

- [ ] 17.2 Обновить документацию IPFS-Cluster
  - Добавить ScyllaDB в документацию по бэкендам состояния
  - Создать руководство по миграции для существующих пользователей
  - Обновить примеры конфигураций в репозитории
  - _Требования: 4.3_

- [ ] 17.3 Создать enterprise документацию
  - Написать руководство по развертыванию enterprise архитектуры
  - Создать документацию по настройке Security/AuthZ и биллинга
  - Добавить примеры интеграции с внешними системами
  - _Требования: 9.2, 10.4, 11.5_